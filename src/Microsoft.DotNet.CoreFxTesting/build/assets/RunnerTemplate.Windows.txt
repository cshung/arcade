@echo off
setlocal enabledelayedexpansion

set EXECUTION_DIR=%~dp0

set /a "argparser_runtime_path_specification_count=0"
set /a "argparser_dotnet_root_specification_count=0"
set /a "argparser_global_tool_dir_specification_count=0"
set /a "argparser_xunit_rsp_specification_count=0"
:argparser
:argparser_start
  if "%~1" == "" goto argparser_end
  set "argparser_currentarg=%~1"
  shift
  set "argparser_currentarg_prefix=%argparser_currentarg:~0,2%"
  if "%argparser_currentarg_prefix%" == "--" (
    set "argparser_currentarg=%argparser_currentarg:~1%"
  )
  if /i "%argparser_currentarg%"=="-r" ( set /a "argparser_runtime_path_specification_count=!argparser_runtime_path_specification_count!+1" )
  if /i "%argparser_currentarg%"=="-runtime-path" ( set /a "argparser_runtime_path_specification_count=!argparser_runtime_path_specification_count!+1" )
  if "%argparser_runtime_path_specification_count%" GEQ "2" ( goto usage )
  if "%argparser_runtime_path_specification_count%" == "1" (
    if "%~1" == "" ( goto usage )
    set "argparser_runtime_path=%~1"
    goto argparser_break
  )
  if /i "%argparser_currentarg%"=="-d" ( set /a "argparser_dotnet_root_specification_count=!argparser_dotnet_root_specification_count!+1" )
  if /i "%argparser_currentarg%"=="-dotnet-root" ( set /a "argparser_dotnet_root_specification_count=!argparser_dotnet_root_specification_count!+1" )
  if "%argparser_dotnet_root_specification_count%" GEQ "2" ( goto usage )
  if "%argparser_dotnet_root_specification_count%" == "1" (
    if "%~1" == "" ( goto usage )
    set "argparser_dotnet_root=%~1"
    goto argparser_break
  )
  if /i "%argparser_currentarg%"=="-g" ( set /a "argparser_global_tool_dir_specification_count=!argparser_global_tool_dir_specification_count!+1" )
  if /i "%argparser_currentarg%"=="-global-tools-dir" ( set /a "argparser_global_tool_dir_specification_count=!argparser_global_tool_dir_specification_count!+1" )
  if "%argparser_global_tool_dir_specification_count%" GEQ "2" ( goto usage )
  if "%argparser_global_tool_dir_specification_count%" == "1" (
    if "%~1" == "" ( goto usage )
    set "argparser_global_tool_dir=%~1"
    goto argparser_break
  )
  if /i "%argparser_currentarg%"=="-x" ( set /a "argparser_xunit_rsp_specification_count=!argparser_xunit_rsp_specification_count!+1" )
  if /i "%argparser_currentarg%"=="-xunit-rsp" ( set /a "argparser_xunit_rsp_specification_count=!argparser_xunit_rsp_specification_count!+1" )
  if "%argparser_xunit_rsp_specification_count%" GEQ "2" ( goto usage )
  if "%argparser_xunit_rsp_specification_count%" == "1" (
    if "%~1" == "" ( goto usage )
    set "argparser_xunit_rsp=%~1"
    goto argparser_break
  )
  goto usage
  :argparser_break
  shift
goto argparser_start
:argparser_end
if "%argparser_runtime_path_specification_count%" == "0"  ( goto usage )
if "%argparser_runtime_path_specification_count%" == "1"  (
    echo The argparser_runtime_path is '%argparser_runtime_path%'
)
if "%argparser_dotnet_root_specification_count%" == "1"  (
    echo The argparser_dotnet_root is '%argparser_dotnet_root%'
)
if "%argparser_global_tool_dir_specification_count%" == "1"  (
    echo The argparser_global_tool_dir is '%argparser_global_tool_dir%'
)
if "%argparser_xunit_rsp_specification_count%" == "1"  (
    echo The argparser_xunit_rsp is '%argparser_xunit_rsp%'
)

set "RUNTIME_PATH=%argparser_runtime_path%"
if "%argparser_dotnet_root_specification_count%" == "1"  (
    set "DOTNET_ROOT=%argparser_dotnet_root%"
)
if "%argparser_global_tool_dir_specification_count%" == "1"  (
    set "GLOBAL_TOOLS_DIR=%argparser_global_tool_dir%"
)
if "%argparser_xunit_rsp_specification_count%" == "1"  (
    set "XUNIT_RSP=%argparser_xunit_rsp%"
)

:: Don't use a globally installed SDK.
set DOTNET_MULTILEVEL_LOOKUP=0

:: Roll forward on [major], [minor] and [patch].
set DOTNET_ROLL_FORWARD_ON_NO_CANDIDATE_FX=2

:: ========================= BEGIN Test Execution ============================= 
echo ----- start %TIME% ===============  To repro directly: ===================================================== 
echo pushd %EXECUTION_DIR%
[[RunCommandsEcho]]
echo popd
echo ===========================================================================================================
pushd %EXECUTION_DIR%
@echo on
[[RunCommands]]
@echo off
popd
echo ----- end %TIME% ----- exit code %ERRORLEVEL% ----------------------------------------------------------
EXIT /B %ERRORLEVEL%
:: ========================= END Test Execution =================================

:usage
echo.
echo Usage:
echo.
echo %0 {runtime path}
echo.
echo Parameters:
echo runtime path :        (Mandatory) Root path containing the full test runtime necessary for test execution.
EXIT /B -1